<!DOCTYPE html>
<html>
<head>
    <title>Ball Dash</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            touch-action: none;
        }
        #gameCanvas {
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 100%);
        }
        #hud {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-family: 'Arial Black', sans-serif;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 10px;
            font-size: 20px;
        }
        #deathScreen {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff0000;
            font-size: 48px;
            font-family: 'Impact', sans-serif;
            text-shadow: 3px 3px 0 #000;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <div id="hud">
        Уровень: <span id="level">1</span><br>
        Дистанция: <span id="distance">0</span>m<br>
        Рекорд: <span id="highscore">0</span>m
    </div>
    <div id="deathScreen">
        GAME OVER!<br>
        <span style="font-size: 24px">Тапни для рестарта</span>
    </div>
    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Конфигурация игры
        const CONFIG = {
            BASE_SPEED: 8,
            GRAVITY: 0.8,
            JUMP_FORCE: -16,
            DOUBLE_JUMP_FORCE: -12,
            PLATFORM_SPACING: 300,
            MAX_JUMPS: 2,
            LEVEL_UP_DISTANCE: 1000,
            SPIKE_CHANCE: 0.3
        };

        // Состояние игры
        let gameState = {
            scrollX: 0,
            distance: 0,
            level: 1,
            highscore: parseInt(localStorage.getItem('highscore')) || 0,
            isDead: false,
            platforms: [],
            jumpsLeft: CONFIG.MAX_JUMPS,
            currentSpeed: CONFIG.BASE_SPEED,
            autoMove: true
        };

        const ball = {
            x: canvas.width * 0.3,
            y: canvas.height * 0.5,
            radius: 15,
            color: '#00ff88',
            velocityY: 0
        };

        // Инициализация
        function initGame() {
            gameState = {
                scrollX: 0,
                distance: 0,
                level: 1,
                isDead: false,
                platforms: [],
                jumpsLeft: CONFIG.MAX_JUMPS,
                currentSpeed: CONFIG.BASE_SPEED,
                highscore: gameState.highscore,
                autoMove: true
            };

            // Стартовая платформа
            addPlatform(0, canvas.height - 50, canvas.width, 30, '#2ecc71', false);
            
            // Генерация платформ
            generateInitialPlatforms();
            
            ball.x = canvas.width * 0.3;
            ball.y = canvas.height * 0.5;
            ball.velocityY = 0;

            document.getElementById('deathScreen').style.display = 'none';
            updateHUD();
        }

        function generateInitialPlatforms() {
            let x = 400;
            for(let i = 0; i < 5; i++) {
                const hasSpikes = Math.random() < CONFIG.SPIKE_CHANCE;
                addPlatform(
                    x,
                    canvas.height - 150 - Math.random() * 200,
                    120 + Math.random() * 80,
                    20,
                    hasSpikes ? '#ff4444' : '#3498db',
                    hasSpikes
                );
                x += CONFIG.PLATFORM_SPACING + Math.random() * 200;
            }
        }

        function addPlatform(x, y, width, height, color, hasSpikes) {
            gameState.platforms.push({
                x, y, width, height, color,
                spikes: hasSpikes ? generateSpikes(width) : []
            });
        }

        function generateSpikes(width) {
            const spikes = [];
            const count = Math.floor(width / 30);
            for(let i = 0; i < count; i++) {
                spikes.push({
                    x: 15 + i * 30,
                    height: 20 + Math.random() * 20
                });
            }
            return spikes;
        }

        function updatePhysics() {
            if(gameState.isDead) return;

            // Автоматическое движение вправо
            gameState.scrollX += gameState.currentSpeed;
            gameState.distance = Math.floor(gameState.scrollX);

            // Повышение уровня
            if(gameState.distance >= gameState.level * CONFIG.LEVEL_UP_DISTANCE) {
                gameState.level++;
                gameState.currentSpeed = CONFIG.BASE_SPEED * (1 + (gameState.level-1)*0.12);
            }

            // Физика мяча
            ball.velocityY += CONFIG.GRAVITY;
            ball.y += ball.velocityY;

            // Генерация новых платформ
            const lastPlatform = gameState.platforms[gameState.platforms.length-1];
            if(lastPlatform.x + lastPlatform.width < gameState.scrollX + canvas.width) {
                const hasSpikes = Math.random() < CONFIG.SPIKE_CHANCE;
                addPlatform(
                    lastPlatform.x + lastPlatform.width + CONFIG.PLATFORM_SPACING,
                    canvas.height - 150 - Math.random() * 300,
                    100 + Math.random() * 100,
                    20,
                    hasSpikes ? '#ff4444' : '#3498db',
                    hasSpikes
                );
            }

            // Удаление старых платформ
            gameState.platforms = gameState.platforms.filter(p => 
                p.x + p.width > gameState.scrollX - canvas.width
            );

            // Коллизии и смерть
            let onGround = false;
            gameState.platforms.forEach(platform => {
                if(checkPlatformCollision(platform)) {
                    if(platform.spikes.length > 0) {
                        gameOver();
                        return;
                    }
                    ball.velocityY = 0;
                    ball.y = platform.y - ball.radius;
                    onGround = true;
                }
            });

            gameState.jumpsLeft = onGround ? CONFIG.MAX_JUMPS : gameState.jumpsLeft;

            // Границы экрана
            if(ball.y > canvas.height + 100) gameOver();
        }

        function checkPlatformCollision(platform) {
            // Проверка коллизии с платформой
            if(ball.y + ball.radius < platform.y || 
               ball.y - ball.radius > platform.y + platform.height ||
               ball.x + ball.radius < platform.x - gameState.scrollX ||
               ball.x - ball.radius > platform.x + platform.width - gameState.scrollX) {
                return false;
            }

            // Проверка коллизии с шипами
            if(platform.spikes.length > 0) {
                for(const spike of platform.spikes) {
                    const spikeX = platform.x + spike.x - gameState.scrollX;
                    const spikeTop = platform.y - spike.height;
                    if(ball.x > spikeX - 10 && ball.x < spikeX + 10 &&
                       ball.y + ball.radius > spikeTop) {
                        return true;
                    }
                }
            }
            return true;
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Платформы и шипы
            gameState.platforms.forEach(platform => {
                // Основная платформа
                ctx.fillStyle = platform.color;
                ctx.fillRect(
                    platform.x - gameState.scrollX,
                    platform.y,
                    platform.width,
                    platform.height
                );

                // Шипы
                if(platform.spikes.length > 0) {
                    ctx.fillStyle = '#ff0000';
                    platform.spikes.forEach(spike => {
                        const spikeX = platform.x + spike.x - gameState.scrollX;
                        ctx.beginPath();
                        ctx.moveTo(spikeX - 10, platform.y);
                        ctx.lineTo(spikeX + 10, platform.y);
                        ctx.lineTo(spikeX, platform.y - spike.height);
                        ctx.closePath();
                        ctx.fill();
                    });
                }
            });

            // Мяч
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = ball.color;
            ctx.fill();
        }

        function initControls() {
            // Универсальный обработчик прыжка
            const jumpHandler = () => {
                if(gameState.isDead) {
                    if(gameState.distance > gameState.highscore) {
                        gameState.highscore = gameState.distance;
                        localStorage.setItem('highscore', gameState.highscore);
                    }
                    initGame();
                    return;
                }

                if(gameState.jumpsLeft > 0) {
                    ball.velocityY = gameState.jumpsLeft === CONFIG.MAX_JUMPS 
                        ? CONFIG.JUMP_FORCE 
                        : CONFIG.DOUBLE_JUMP_FORCE;
                    gameState.jumpsLeft--;
                }
            };

            // Десктоп управление
            window.addEventListener('keydown', e => {
                if(e.code === 'Space') jumpHandler();
            });

            // Мобильное управление
            canvas.addEventListener('touchstart', e => {
                e.preventDefault();
                jumpHandler();
            });
            canvas.addEventListener('mousedown', jumpHandler);
        }

        function gameOver() {
            gameState.isDead = true;
            document.getElementById('deathScreen').style.display = 'block';
        }

        function updateHUD() {
            document.getElementById('distance').textContent = gameState.distance;
            document.getElementById('highscore').textContent = gameState.highscore;
            document.getElementById('level').textContent = gameState.level;
        }

        function gameLoop() {
            if(!gameState.isDead) updatePhysics();
            draw();
            updateHUD();
            requestAnimationFrame(gameLoop);
        }

        // Запуск игры
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initGame();
        });

        document.getElementById('highscore').textContent = gameState.highscore;
        initControls();
        initGame();
        gameLoop();
    </script>
</body>
</html>
